# Obsidian Memo Plugin 项目开发规则

## 项目概述

本项目是一个模块化的 Obsidian 插件，展示了 Obsidian 插件开发的最佳实践。项目采用 TypeScript 开发，使用现代化的工具链和严格的代码规范。

## 技术栈

- **开发语言**: TypeScript 4.7.4
- **包管理器**: pnpm
- **构建工具**: esbuild
- **代码检查**: ESLint + TypeScript ESLint
- **目标平台**: Obsidian (最低版本 0.15.0)

## 项目结构规范

```plantext
obsidian-memo-plugin/
├── src/                    # 源代码目录
│   ├── commands/          # 命令管理模块
│   ├── components/        # 可复用组件
│   ├── modals/           # 模态框组件
│   ├── settings/         # 设置页面组件
│   ├── types/            # TypeScript 类型定义
│   └── views/            # 视图组件
├── main.ts               # 插件入口文件
├── manifest.json         # 插件清单文件
├── package.json          # 项目配置文件
├── tsconfig.json         # TypeScript 配置
├── esbuild.config.mjs    # 构建配置
└── styles.css            # 样式文件
```

## 代码规范

### 1. TypeScript 规范

- **严格类型检查**: 启用 `strictNullChecks` 和 `noImplicitAny`
- **类型定义**: 所有公共接口必须有明确的类型定义
- **避免 any**: 除非必要（如循环依赖），否则禁止使用 `any` 类型
- **接口命名**: 使用 PascalCase，接口名以具体功能命名（如 `MemoPluginSettings`）

### 2. 文件命名规范

- **文件名**: 使用 PascalCase（如 `SettingTab.ts`、`SampleModal.ts`）
- **目录名**: 使用小写复数形式（如 `commands`、`modals`、`settings`）
- **类型文件**: 统一放在 `src/types/` 目录下

### 3. 代码组织规范

- **单一职责**: 每个类/模块只负责一个特定功能
- **模块化设计**: 功能按模块划分，避免单文件过大
- **依赖注入**: 通过构造函数传递依赖，便于测试和维护

### 4. 注释规范

- **JSDoc 注释**: 所有公共方法和类必须有 JSDoc 注释
- **中文注释**: 代码注释使用中文，便于团队理解
- **功能说明**: 复杂逻辑必须添加解释性注释

```typescript
/**
 * 命令管理器 - 负责注册和管理所有插件命令
 */
export class CommandManager {
    /**
     * 注册所有命令
     */
    registerCommands(): void {
        // 实现逻辑
    }
}
```

## 架构设计原则

### 1. 模块化架构

- **命令管理**: `CommandManager` 类统一管理所有命令注册
- **设置管理**: 独立的设置页面组件和类型定义
- **UI 组件**: 模态框、视图等 UI 组件独立封装
- **类型系统**: 统一的类型定义文件

### 2. 生命周期管理

- **插件加载**: `onload()` 方法中按顺序初始化各模块
- **资源清理**: `onunload()` 方法中清理事件监听器和资源
- **设置持久化**: 使用 Obsidian 提供的设置保存机制

### 3. 错误处理

- **异步操作**: 所有异步操作必须使用 try-catch 包装
- **用户反馈**: 使用 `Notice` 组件向用户提供操作反馈
- **日志记录**: 重要操作和错误必须记录到控制台

## 开发流程

### 1. 环境准备

```bash
# 安装依赖
pnpm install

# 启动开发模式
pnpm run dev

# 构建生产版本
pnpm run build
```

### 2. 开发步骤

1. **需求分析**: 明确功能需求和用户场景
2. **类型定义**: 在 `src/types/` 中定义相关类型
3. **核心逻辑**: 实现主要功能逻辑
4. **UI 组件**: 开发用户界面组件
5. **命令注册**: 在 `CommandManager` 中注册新命令
6. **测试验证**: 在 Obsidian 中测试功能
7. **文档更新**: 更新相关文档

### 3. 代码提交规范

- **提交信息**: 使用 Conventional Commits 规范
- **功能分支**: 每个新功能使用独立分支开发
- **代码审查**: 重要变更需要代码审查

```bash
# 提交示例
git commit -m "feat: 添加备忘录快速创建功能"
git commit -m "fix: 修复设置页面保存问题"
git commit -m "docs: 更新 README 文档"
```

## 性能优化

### 1. 启动性能

- **延迟加载**: 非核心功能延迟到需要时再加载
- **最小化初始化**: `onload()` 中只执行必要的初始化操作
- **避免同步操作**: 避免在主线程执行耗时的同步操作

### 2. 运行时性能

- **事件节流**: 高频事件使用节流或防抖处理
- **内存管理**: 及时清理不需要的事件监听器和定时器
- **DOM 操作**: 批量处理 DOM 操作，避免频繁重绘

### 3. 构建优化

- **Tree Shaking**: 利用 esbuild 的 Tree Shaking 功能
- **代码分割**: 大型功能模块考虑代码分割
- **资源压缩**: 生产构建启用代码压缩

## 测试策略

### 1. 手动测试

- **功能测试**: 验证所有功能按预期工作
- **兼容性测试**: 在不同操作系统和 Obsidian 版本下测试
- **性能测试**: 验证插件不影响 Obsidian 整体性能

### 2. 用户体验测试

- **界面一致性**: 确保 UI 风格与 Obsidian 保持一致
- **操作流畅性**: 验证用户操作流程的流畅性
- **错误处理**: 测试各种异常情况的处理

## 发布流程

### 1. 版本管理

- **语义化版本**: 遵循 SemVer 版本规范
- **版本文件**: 同步更新 `manifest.json`、`package.json` 和 `versions.json`
- **变更日志**: 维护详细的 CHANGELOG

### 2. 发布检查清单

- [ ] 代码通过 ESLint 检查
- [ ] TypeScript 编译无错误
- [ ] 所有功能测试通过
- [ ] 文档更新完整
- [ ] 版本号正确更新
- [ ] 构建产物正常

### 3. 社区发布

- **插件描述**: 提供清晰的功能描述和使用说明
- **截图演示**: 提供功能截图或 GIF 演示
- **用户文档**: 编写详细的用户使用指南
- **开发者文档**: 提供开发者贡献指南

## 安全考虑

### 1. 数据安全

- **数据验证**: 对用户输入进行严格验证
- **权限控制**: 只访问必要的文件和数据
- **敏感信息**: 避免在代码中硬编码敏感信息

### 2. 代码安全

- **依赖管理**: 定期更新依赖包，修复安全漏洞
- **代码审查**: 重要变更进行安全代码审查
- **最小权限**: 插件只请求必要的权限

## 维护指南

### 1. 依赖更新

- **定期检查**: 每月检查依赖包更新
- **安全更新**: 优先处理安全相关的依赖更新
- **兼容性测试**: 更新后进行充分的兼容性测试

### 2. 社区支持

- **问题响应**: 及时响应用户反馈和问题报告
- **功能请求**: 评估和实现合理的功能请求
- **文档维护**: 保持文档的准确性和完整性

### 3. 技术债务

- **代码重构**: 定期重构老旧代码
- **性能优化**: 持续监控和优化性能
- **架构升级**: 适时升级技术架构

## Obsidian 界面结构与UI设计规范

### 1. 主界面布局分析

基于Obsidian界面截图分析，主要界面组件包括：

#### 左侧边栏（Sidebar Left）

- **文件浏览器**: 显示vault中的文件和文件夹结构
- **搜索功能**: 全局搜索文件内容
- **标签管理**: 管理和浏览标签
- **收藏夹**: 快速访问常用文件

#### 主编辑区域（Main Editor）

- **编辑器视图**: 支持Markdown编辑和实时预览
- **阅读视图**: 渲染后的文档显示
- **标签页管理**: 支持多文件同时打开
- **工具栏**: 格式化工具和快捷操作

#### 右侧边栏（Sidebar Right）

- **链接提及**: 显示当前文件的反向链接
- **大纲视图**: 文档结构导航
- **标签面板**: 相关标签显示
- **日历视图**: 日期相关功能

#### 状态栏（Status Bar）

- **文档统计**: 字符数、单词数等信息
- **同步状态**: 显示文件同步状态
- **插件状态**: 显示活跃插件信息

### 2. UI设计原则

#### 界面一致性

- **颜色方案**: 遵循Obsidian的深色/浅色主题
- **字体规范**: 使用系统默认字体或用户自定义字体
- **图标风格**: 使用Lucide图标库或保持一致的图标风格
- **间距规范**: 遵循8px网格系统

#### 交互设计

- **响应式设计**: 适配不同屏幕尺寸
- **键盘快捷键**: 提供完整的键盘操作支持
- **拖拽操作**: 支持文件和内容的拖拽
- **上下文菜单**: 提供右键菜单功能

#### 可访问性

- **键盘导航**: 支持Tab键导航
- **屏幕阅读器**: 提供适当的ARIA标签
- **对比度**: 确保文本和背景有足够对比度
- **焦点指示**: 清晰的焦点状态显示

### 3. 插件UI集成规范

#### 视图集成

- **叶子视图**: 使用`WorkspaceLeaf`创建新的视图类型
- **侧边栏集成**: 通过`addRibbonIcon`添加侧边栏图标
- **状态栏集成**: 使用`addStatusBarItem`添加状态栏元素
- **命令面板**: 通过`addCommand`注册命令

#### 模态框设计

- **尺寸规范**: 适中的模态框尺寸，不遮挡重要内容
- **关闭机制**: 提供ESC键和点击外部关闭功能
- **表单设计**: 清晰的表单布局和验证提示
- **按钮布局**: 主要操作按钮在右侧，取消按钮在左侧

#### 设置页面

- **分组组织**: 使用`Setting`类创建设置项
- **描述文本**: 提供清晰的设置项说明
- **输入验证**: 实时验证用户输入
- **保存机制**: 自动保存或明确的保存按钮

### 4. 响应式布局适配

#### 移动端适配

- **触摸友好**: 按钮和链接有足够的点击区域
- **手势支持**: 支持滑动和缩放手势
- **布局调整**: 在小屏幕上合理调整布局

#### 桌面端优化

- **多窗口支持**: 支持多窗口和分屏操作
- **快捷键**: 完整的桌面快捷键支持
- **右键菜单**: 丰富的上下文菜单

### 5. 主题兼容性

#### CSS变量使用

- **颜色变量**: 使用Obsidian提供的CSS变量
- **字体变量**: 遵循字体相关的CSS变量
- **间距变量**: 使用标准的间距变量

#### 主题适配

- **深色模式**: 确保在深色主题下正常显示
- **浅色模式**: 在浅色主题下保持良好对比度
- **自定义主题**: 兼容社区主题的样式覆盖

```css
/* 示例：使用Obsidian CSS变量 */
.memo-plugin-container {
    background-color: var(--background-primary);
    color: var(--text-normal);
    border: 1px solid var(--background-modifier-border);
    border-radius: var(--radius-s);
    padding: var(--size-4-2);
}

.memo-plugin-button {
    background-color: var(--interactive-accent);
    color: var(--text-on-accent);
    border-radius: var(--button-radius);
    padding: var(--size-2-1) var(--size-4-2);
}
```

## 团队协作

### 1. 沟通规范

- **技术讨论**: 重要技术决策需要团队讨论
- **进度同步**: 定期同步开发进度
- **知识分享**: 分享开发经验和最佳实践

### 2. 代码协作

- **分支策略**: 使用 Git Flow 或 GitHub Flow
- **代码审查**: 所有代码变更需要审查
- **冲突解决**: 及时解决代码冲突

### 3. 文档协作

- **文档同步**: 代码变更同步更新文档
- **版本控制**: 文档也纳入版本控制
- **多语言支持**: 考虑提供多语言文档

---

**注意**: 本规则文档是活文档，会根据项目发展和团队经验持续更新和完善。所有团队成员都有责任遵循这些规则，并提出改进建议。
